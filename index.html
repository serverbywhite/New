<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Random Key Galaxy</title>
<style>
  html, body {
    margin: 0; padding: 0;
    height: 100%; overflow: hidden;
    background: #000;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    color: #fff; font-family: monospace;
  }
  #key {
    font-size: 1.6rem; padding: 1rem 2rem; border: 2px solid #00f5ff;
    border-radius: 10px; background: rgba(0,0,0,0.5);
    box-shadow: 0 0 20px #00f5ff; word-break: break-all; z-index: 10;
  }
  button {
    margin-top: 1rem; padding: 0.6rem 1.2rem; border: none;
    border-radius: 8px; background: #00f5ff; color: #000; font-weight: bold;
    cursor: pointer; transition: 0.3s; z-index: 10;
  }
  button:hover { background: #00ffffaa; }
  #galaxy, #stars {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    z-index: 0;
  }
  #stars { z-index: 1; pointer-events: none; }
</style>
</head>
<body>
<canvas id="galaxy"></canvas>
<canvas id="stars"></canvas>
<div id="key">Đang tạo key...</div>
<button id="copyBtn" style="display:none;">Copy Key</button>

<!-- Load Three.js (chỉ 1 link chuẩn) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r152/three.min.js"></script>

<script>
/* ========== MockAPI logic ========== */
const MOCKAPI = 'https://6887692e071f195ca980a354.mockapi.io/Key';
const H24 = 24 * 60 * 60 * 1000;

function genKey(len = 32) {
  const arr = new Uint8Array(len/2);
  crypto.getRandomValues(arr);
  return Array.from(arr).map(b => b.toString(16).padStart(2,'0')).join('');
}

async function getIp() {
  try {
    const r2 = await fetch('https://api.ipify.org?format=json');
    const j = await r2.json();
    return j.ip;
  } catch {
    return 'unknown';
  }
}

async function sendKeyRecord(key, ip) {
  return fetch(MOCKAPI, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ key, ip, createdAt: new Date().toISOString() })
  });
}

async function deleteExpiredKeys() {
  try {
    const res = await fetch(MOCKAPI);
    const keys = await res.json();
    const now = Date.now();
    for (const k of keys) {
      if (now - new Date(k.createdAt).getTime() > H24) {
        await fetch(`${MOCKAPI}/${k.id}`, { method: 'DELETE' });
        console.log('Đã xoá key hết hạn:', k.key);
      }
    }
  } catch (e) { console.warn('Không thể xoá key:', e); }
}

/* ========== Galaxy 3D ========== */
const galaxyCanvas = document.getElementById('galaxy');
const renderer = new THREE.WebGLRenderer({canvas: galaxyCanvas, antialias: true});
renderer.setSize(window.innerWidth, window.innerHeight);

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 2000);
camera.position.z = 400;

const geometry = new THREE.BufferGeometry();
const count = 5000;
const positions = new Float32Array(count * 3);
const colors = new Float32Array(count * 3);

for (let i = 0; i < count; i++) {
  const r = Math.random() * 400 + 100;
  const theta = Math.random() * 2 * Math.PI;
  const phi = Math.random() * Math.PI;
  positions[i*3] = r * Math.sin(phi) * Math.cos(theta);
  positions[i*3+1] = r * Math.sin(phi) * Math.sin(theta);
  positions[i*3+2] = r * Math.cos(phi);
  const color = new THREE.Color(`hsl(${Math.random()*360}, 100%, 70%)`);
  colors[i*3] = color.r;
  colors[i*3+1] = color.g;
  colors[i*3+2] = color.b;
}

geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
const material = new THREE.PointsMaterial({ size: 2, vertexColors: true, transparent: true });
const points = new THREE.Points(geometry, material);
scene.add(points);

function animateGalaxy() {
  requestAnimationFrame(animateGalaxy);
  points.rotation.y += 0.0009;
  points.rotation.x += 0.0004;
  renderer.render(scene, camera);
}
animateGalaxy();

window.addEventListener('resize', () => {
  renderer.setSize(window.innerWidth, window.innerHeight);
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
});

/* ========== Sao "★" rơi bật nảy ========== */
const starCanvas = document.getElementById('stars');
const ctx = starCanvas.getContext('2d');
let stars = [];
const colors2 = ['#00f5ff','#ff1493','#ffd700','#7fff00','#ff4500','#8a2be2'];
let W,H;

function resize2() {
  W = starCanvas.width = window.innerWidth;
  H = starCanvas.height = window.innerHeight;
}
window.addEventListener('resize', resize2);
resize2();

class Star {
  constructor() { this.reset(true); }
  reset(init=false) {
    this.x = Math.random()*W;
    this.y = init ? Math.random()*H : -20;
    this.vx = (Math.random()-0.5)*2;
    this.vy = Math.random()*2+1;
    this.color = colors2[Math.floor(Math.random()*colors2.length)];
    this.size = Math.random()*16+8;
  }
  update() {
    this.x += this.vx; this.y += this.vy; this.vy += 0.03;
    if (this.x<=0||this.x>=W) this.vx*=-1;
    if (this.y>=H-this.size){this.vy*=-0.8;this.y=H-this.size;if(Math.abs(this.vy)<0.5)this.reset();}
  }
  draw() {
    ctx.save(); ctx.translate(this.x,this.y); ctx.fillStyle=this.color; ctx.font=`${this.size}px Arial`; ctx.fillText('★',0,0); ctx.restore();
  }
}
for(let i=0;i<250;i++) stars.push(new Star());
function animateStars(){
  ctx.clearRect(0,0,W,H);
  for(const s of stars){s.update();s.draw();}
  requestAnimationFrame(animateStars);
}
animateStars();

/* ========== Main logic key ========== */
(async () => {
  await deleteExpiredKeys();
  const key = genKey();
  document.getElementById('key').textContent = key;
  document.getElementById('copyBtn').style.display = 'inline-block';
  const ip = await getIp();
  await sendKeyRecord(key, ip);
})();

/* Copy */
document.getElementById('copyBtn').onclick = async () => {
  const keyText = document.getElementById('key').textContent;
  await navigator.clipboard.writeText(keyText);
  const btn = document.getElementById('copyBtn');
  const old = btn.textContent;
  btn.textContent = 'Đã copy!';
  setTimeout(()=>btn.textContent = old, 1500);
};
</script>
</body>
</html>
